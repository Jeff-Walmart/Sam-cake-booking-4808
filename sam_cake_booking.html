<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±±å§†è‰è“è›‹ç³•é¢„çº¦</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            background: #fff;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        .welcome {
            text-align: center;
            color: #1890ff;
            font-size: 1.1em;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: #E50000;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            margin: 10px 0;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-outline {
            background: #fff;
            color: #6c757d;
            border: 1px solid #ddd;
        }
        .code {
            font-size: 1.8em;
            font-weight: bold;
            color: #E50000;
            text-align: center;
            margin: 15px 0;
        }
        #resultSection, #staff-panel {
            display: none;
        }
        .small {
            text-align: center;
            font-size: 0.85em;
            color: #888;
            margin-top: 15px;
        }
        .small a {
            color: #888;
            text-decoration: underline;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .modal-content {
            background: white;
            margin: 100px auto;
            padding: 20px;
            width: 90%;
            max-width: 300px;
            border-radius: 8px;
        }
        .note {
            font-size: 0.9em;
            color: #666;
            margin-top: 12px;
            line-height: 1.5;
        }
        .time-info {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        .slot-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #1890ff;
            margin: 10px 0;
        }
        .countdown {
            font-size: 0.9em;
            color: #E50000;
            margin-top: 5px;
        }
        .warning {
            background: #fff7e6;
            border: 1px solid #ffd591;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .business-hours-config {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .time-range-selectors {
            display: flex;
            gap: 5px;
            align-items: center;
            margin: 10px 0;
        }
        .time-range-selectors select {
            flex: 1;
        }
        .time-label {
            font-size: 0.9em;
            color: #666;
            margin: 5px 0;
        }
        .schedule-info {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .divider {
            margin: 0 5px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="member-section">
            <div class="welcome">æ¬¢è¿å…‰ä¸´è¥¿æºªå±±å§†ä¼šå‘˜å•†åº—</div>
            
            <!-- æ—¶é—´ä¿¡æ¯å±•ç¤º -->
            <div class="card" id="timeSection">
                <div class="time-info">
                    <div>å½“å‰æ—¶é—´ï¼š<span id="currentTime">--:--</span></div>
                    <div class="slot-display">
                        å½“å‰é¢„çº¦æ—¶æ®µï¼š<span id="currentSlot">--:-- - --:--</span>
                    </div>
                    <div class="slot-display">
                        å¯é¢„çº¦å–è´§æ—¶æ®µï¼š<span id="pickupTimeSlot">--:-- - --:--</span>
                    </div>
                    <div class="countdown">
                        è·ç¦»ä¸‹ä¸ªæ—¶æ®µï¼š<span id="countdown">--åˆ†--ç§’</span>
                    </div>
                </div>
                <div class="schedule-info">
                    â° é¢„çº¦è§„åˆ™ï¼šå½“å‰æ—¶æ®µé¢„çº¦ä¸‹ä¸€æ—¶æ®µçš„è›‹ç³•<br>
                    ğŸ“… è¥ä¸šæ—¶é—´ï¼š<span id="displayHours">09:00-20:00</span>
                </div>
                <div class="warning" id="timeWarning"></div>
            </div>
            
            <!-- é¢„çº¦åŒºåŸŸ -->
            <div class="card">
                <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼ŒéªŒè¯æ‚¨åœ¨é—¨åº—é™„è¿‘ä»¥é¢„çº¦è‰è“è›‹ç³•ã€‚</p>
                <div class="note">
                    ğŸ”’ æ‚¨çš„ä½ç½®ä¿¡æ¯ä»…åœ¨æœ¬åœ°è®¾å¤‡ä½¿ç”¨ï¼Œç”¨äºæœ¬æ¬¡è·ç¦»è®¡ç®—ï¼Œ<strong>ä¸ä¼šä¸Šä¼ ã€ä¿å­˜æˆ–æ³„éœ²</strong>ï¼Œè¯·æ”¾å¿ƒæˆæƒã€‚<br>
                    â° æ¯ä¸ªè®¾å¤‡æ¯å¤©åªèƒ½é¢„çº¦1æ¬¡ã€‚
                </div>
                <button class="btn" id="bookBtn" onclick="getLocation()">âœ… è·å–ä½ç½®å¹¶é¢„çº¦</button>
                <div id="status"></div>
            </div>
            
            <!-- é¢„çº¦ç»“æœ -->
            <div class="card" id="resultSection">
                <p>ğŸ‰ é¢„çº¦æˆåŠŸï¼</p>
                <div class="time-info">
                    <p>å–è´§æ—¶æ®µï¼š<strong id="pickupSlot">--:-- - --:--</strong></p>
                    <p>å–è´§ç ï¼š<span class="code" id="codeDisplay">â€”â€”</span></p>
                </div>
                <p>è¯·å‡­æ­¤é¡µé¢åˆ°è›‹ç³•åŒºé¢†å–</p>
            </div>
            
            <div class="small">
                <a href="#" onclick="showStaffLogin(); return false;">å‘˜å·¥å…¥å£</a>
            </div>
        </div>

        <!-- å‘˜å·¥ç™»å½•æ¨¡æ€æ¡† -->
        <div id="staff-login" class="modal">
            <div class="modal-content">
                <h3 style="text-align:center;margin-bottom:15px;">å·¥ä½œäººå‘˜ç™»å½•</h3>
                <input type="password" id="staffPinInput" placeholder="è¯·è¾“å…¥å·¥å·" autofocus>
                <button class="btn" onclick="doStaffLogin()">ç™»å½•</button>
                <button class="btn btn-outline" onclick="hideStaffLogin()">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- å¢åŠ å‘˜å·¥æ¨¡æ€æ¡† -->
        <div id="add-staff-modal" class="modal">
            <div class="modal-content">
                <h3 style="text-align:center;margin-bottom:15px;">â• å¢åŠ å…¶ä»–äººå‘˜</h3>
                <input type="text" id="newStaffPin" placeholder="è¾“å…¥æ–°å·¥å·" maxlength="20">
                <button class="btn" style="background:#1890ff;" onclick="saveNewStaff()">ä¿å­˜</button>
                <button class="btn btn-outline" onclick="document.getElementById('add-staff-modal').style.display='none'">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- ä¿®æ”¹ä½ç½®æ¨¡æ€æ¡† -->
        <div id="edit-location-modal" class="modal">
            <div class="modal-content">
                <h3 style="text-align:center;margin-bottom:15px;">ğŸ“ ä¿®æ”¹é—¨åº—å®šä½</h3>
                <input type="text" id="newLat" placeholder="çº¬åº¦ï¼ˆä¾‹å¦‚ï¼š30.247204ï¼‰">
                <input type="text" id="newLng" placeholder="ç»åº¦ï¼ˆä¾‹å¦‚ï¼š120.049063ï¼‰">
                <button class="btn" style="background:#52c41a;" onclick="saveNewLocation()">ä¿å­˜å®šä½</button>
                <button class="btn btn-outline" onclick="document.getElementById('edit-location-modal').style.display='none'">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- ä¿®æ”¹è¥ä¸šæ—¶é—´æ¨¡æ€æ¡† -->
        <div id="edit-hours-modal" class="modal">
            <div class="modal-content">
                <h3 style="text-align:center;margin-bottom:15px;">â° ä¿®æ”¹è¥ä¸šæ—¶é—´</h3>
                <div class="business-hours-config">
                    <div class="time-label">è¥ä¸šæ—¶é—´æ®µï¼š</div>
                    <div class="time-range-selectors">
                        <select id="startHour">
                            <option value="8">08:00</option>
                            <option value="9" selected>09:00</option>
                            <option value="10">10:00</option>
                            <option value="11">11:00</option>
                        </select>
                        <span class="divider">è‡³</span>
                        <select id="endHour">
                            <option value="19">19:00</option>
                            <option value="20" selected>20:00</option>
                            <option value="21">21:00</option>
                            <option value="22">22:00</option>
                        </select>
                    </div>
                    <div class="time-label" style="margin-top:10px;">é¢„çº¦è§„åˆ™ï¼šæ¯åŠå°æ—¶ä¸ºä¸€ä¸ªæ—¶æ®µï¼Œå½“å‰æ—¶æ®µé¢„çº¦ä¸‹ä¸€æ—¶æ®µçš„è›‹ç³•</div>
                </div>
                <button class="btn" style="background:#1890ff;" onclick="saveBusinessHours()">ä¿å­˜è¥ä¸šæ—¶é—´</button>
                <button class="btn btn-outline" onclick="document.getElementById('edit-hours-modal').style.display='none'">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- å‘˜å·¥åå° -->
        <div id="staff-panel">
            <h1 style="text-align:center;color:#1890ff;margin-bottom:20px;">âš™ï¸ å‘˜å·¥åå°</h1>
            <div class="card">
                <div class="time-info">
                    <p>å½“å‰é¢„çº¦æ—¶æ®µï¼š<strong id="staffCurrentSlot">--:-- - --:--</strong></p>
                    <p>å¯é¢„çº¦å–è´§æ—¶æ®µï¼š<strong id="staffPickupSlot">--:-- - --:--</strong></p>
                </div>
                <div id="dailyStats" style="margin: 15px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                    <p>ä»Šæ—¥å·²é¢„çº¦ï¼š<span id="todayTotal">0</span> äºº</p>
                    <p>è¥ä¸šæ—¶é—´ï¼š<span id="staffHoursDisplay">09:00-20:00</span></p>
                    <p>æ€»é¢„çº¦äººæ¬¡ï¼š<span id="totalBookings">0</span></p>
                </div>
                <button class="btn" style="background:#1890ff;" onclick="addNewStaff()">â• å¢åŠ å…¶ä»–äººå‘˜</button>
                <button class="btn" style="background:#52c41a;" onclick="editLocation()">ğŸ“ ä¿®æ”¹é—¨åº—å®šä½</button>
                <button class="btn" style="background:#fa8c16;" onclick="editBusinessHours()">â° ä¿®æ”¹è¥ä¸šæ—¶é—´</button>
                <button class="btn btn-outline" onclick="clearTodayData()" style="margin-top:10px;">ğŸ—‘ï¸ æ¸…é™¤ä»Šæ—¥æ•°æ®</button>
                <button class="btn btn-outline" onclick="logoutStaff()" style="margin-top:10px;">â¬…ï¸ é€€å‡º</button>
            </div>
            <div class="small">
                <a href="#" onclick="goBackToMember(); return false;">â† è¿”å›é¢„çº¦é¡µ</a>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®å¸¸é‡
        const DEFAULT_CONFIG = {
            lat: 30.247204,
            lng: 120.049063,
            radius: 1000
        };

        const SLOT_DURATION = 30; // åˆ†é’Ÿ
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è¥ä¸šæ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
        let BUSINESS_HOURS = JSON.parse(localStorage.getItem('business_hours')) || {
            start_hour: 9,
            end_hour: 20
        };

        let CONFIG = JSON.parse(localStorage.getItem('store_config')) || DEFAULT_CONFIG;
        
        // å…¨å±€æ—¶é—´è·Ÿè¸ª
        let currentSlot = null;      // å½“å‰é¢„çº¦æ—¶æ®µ
        let pickupSlot = null;       // å¯é¢„çº¦çš„å–è´§æ—¶æ®µï¼ˆä¸‹ä¸€æ—¶æ®µï¼‰
        let timeCheckInterval = null;
        let countdownInterval = null;

        // åˆå§‹åŒ–é¡µé¢
        function initPage() {
            // æ›´æ–°è¥ä¸šæ—¶é—´æ˜¾ç¤º
            updateHoursDisplay();
            
            updateTimeDisplay();
            checkUserTodayBooking();
            
            // æ¯10ç§’æ›´æ–°æ—¶é—´æ˜¾ç¤º
            timeCheckInterval = setInterval(updateTimeDisplay, 10000);
            
            // æ¯ç§’æ›´æ–°å€’è®¡æ—¶
            countdownInterval = setInterval(updateCountdown, 1000);
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateTotalBookings();
        }

        // æ›´æ–°æ€»é¢„çº¦äººæ¬¡
        function updateTotalBookings() {
            const allBookings = JSON.parse(localStorage.getItem('cake_bookings') || '[]');
            document.getElementById('totalBookings').textContent = allBookings.length;
        }

        // æ›´æ–°è¥ä¸šæ—¶é—´æ˜¾ç¤º
        function updateHoursDisplay() {
            const startTime = BUSINESS_HOURS.start_hour.toString().padStart(2, '0') + ':00';
            const endTime = BUSINESS_HOURS.end_hour.toString().padStart(2, '0') + ':00';
            document.getElementById('displayHours').textContent = startTime + '-' + endTime;
            document.getElementById('staffHoursDisplay').textContent = startTime + '-' + endTime;
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤ºå’Œæ—¶æ®µè®¡ç®—
        function updateTimeDisplay() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // æ˜¾ç¤ºå½“å‰æ—¶é—´
            document.getElementById('currentTime').textContent = 
                now.getHours().toString().padStart(2, '0') + ':' + 
                now.getMinutes().toString().padStart(2, '0');
            
            // æ£€æŸ¥æ˜¯å¦åœ¨è¥ä¸šæ—¶é—´å†…
            const startHour = BUSINESS_HOURS.start_hour;
            const endHour = BUSINESS_HOURS.end_hour;
            
            if (currentHour < startHour || currentHour >= endHour) {
                const startTime = startHour.toString().padStart(2, '0') + ':00';
                const endTime = endHour.toString().padStart(2, '0') + ':00';
                document.getElementById('timeWarning').textContent = 
                    'â° å½“å‰éè¥ä¸šæ—¶é—´ï¼ˆè¥ä¸šæ—¶é—´ï¼š' + startTime + '-' + endTime + 'ï¼‰';
                document.getElementById('bookBtn').disabled = true;
                return;
            } else {
                document.getElementById('timeWarning').textContent = '';
            }
            
            // è®¡ç®—å½“å‰æ—¶æ®µï¼ˆå‘ä¸‹å–æ•´åˆ°30åˆ†é’Ÿï¼‰
            const slotStartMinute = Math.floor(currentMinute / SLOT_DURATION) * SLOT_DURATION;
            const slotEndMinute = slotStartMinute + SLOT_DURATION;
            
            // å½“å‰é¢„çº¦æ—¶æ®µ
            currentSlot = {
                start: new Date(now.getFullYear(), now.getMonth(), now.getDate(), currentHour, slotStartMinute),
                end: new Date(now.getFullYear(), now.getMonth(), now.getDate(), currentHour, slotEndMinute)
            };
            
            // è®¡ç®—å¯é¢„çº¦çš„å–è´§æ—¶æ®µï¼ˆä¸‹ä¸€æ—¶æ®µï¼‰
            pickupSlot = new Date(currentSlot.end.getTime());
            const pickupEnd = new Date(pickupSlot.getTime());
            pickupEnd.setMinutes(pickupEnd.getMinutes() + SLOT_DURATION);
            
            // æ£€æŸ¥å–è´§æ—¶æ®µæ˜¯å¦åœ¨è¥ä¸šæ—¶é—´å†…
            const pickupSlotHour = pickupSlot.getHours();
            if (pickupSlotHour >= endHour) {
                document.getElementById('timeWarning').textContent = 
                    'âš ï¸ ä»Šæ—¥æœ€åä¸€ä¸ªé¢„çº¦æ—¶æ®µå·²ç»“æŸ';
                document.getElementById('bookBtn').disabled = true;
                return;
            }
            
            // æ˜¾ç¤ºæ—¶æ®µä¿¡æ¯
            document.getElementById('currentSlot').textContent = 
                formatTime(currentSlot.start) + ' - ' + formatTime(currentSlot.end);
            document.getElementById('pickupTimeSlot').textContent = 
                formatTime(pickupSlot) + ' - ' + formatTime(pickupEnd);
            
            // å‘˜å·¥é¢æ¿ä¹Ÿæ›´æ–°
            document.getElementById('staffCurrentSlot').textContent = 
                formatTime(currentSlot.start) + ' - ' + formatTime(currentSlot.end);
            document.getElementById('staffPickupSlot').textContent = 
                formatTime(pickupSlot) + ' - ' + formatTime(pickupEnd);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonState();
        }

        // æ›´æ–°å€’è®¡æ—¶
        function updateCountdown() {
            if (!currentSlot) return;
            
            const now = new Date();
            const timeToNextSlot = currentSlot.end - now;
            
            if (timeToNextSlot > 0) {
                const minutes = Math.floor(timeToNextSlot / (1000 * 60));
                const seconds = Math.floor((timeToNextSlot % (1000 * 60)) / 1000);
                document.getElementById('countdown').textContent = 
                    minutes + 'åˆ†' + seconds.toString().padStart(2, '0') + 'ç§’';
            } else {
                document.getElementById('countdown').textContent = '00åˆ†00ç§’';
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            return date.getHours().toString().padStart(2, '0') + ':' + 
                   date.getMinutes().toString().padStart(2, '0');
        }

        // æ£€æŸ¥ç”¨æˆ·ä»Šæ—¥æ˜¯å¦å·²é¢„çº¦
        function checkUserTodayBooking() {
            const today = new Date().toDateString();
            const bookings = JSON.parse(localStorage.getItem('cake_bookings') || '[]');
            
            // æ£€æŸ¥è®¾å¤‡æŒ‡çº¹ï¼ˆç®€åŒ–ç‰ˆï¼‰
            const deviceId = localStorage.getItem('device_id') || generateDeviceId();
            localStorage.setItem('device_id', deviceId);
            
            const userBookedToday = bookings.some(booking => {
                const bookingDate = new Date(booking.time).toDateString();
                return bookingDate === today && booking.deviceId === deviceId;
            });
            
            if (userBookedToday) {
                const userBooking = bookings.find(b => 
                    new Date(b.time).toDateString() === today && b.deviceId === deviceId
                );
                if (userBooking) {
                    showExistingBooking(userBooking);
                }
            }
        }

        // ç”Ÿæˆè®¾å¤‡ID
        function generateDeviceId() {
            return 'device_' + Math.random().toString(36).substr(2, 9) + 
                   '_' + Date.now().toString(36);
        }

        // æ˜¾ç¤ºå·²æœ‰é¢„çº¦
        function showExistingBooking(booking) {
            document.getElementById('pickupSlot').textContent = booking.pickupSlot;
            document.getElementById('codeDisplay').textContent = booking.code;
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('bookBtn').disabled = true;
            document.getElementById('bookBtn').textContent = 'ä»Šæ—¥å·²é¢„çº¦';
        }

        // æ›´æ–°ä»Šæ—¥ç»Ÿè®¡æ•°æ®
        function updateDailyStats() {
            const today = new Date().toDateString();
            const allBookings = JSON.parse(localStorage.getItem('cake_bookings') || '[]');
            
            const todayBookings = allBookings.filter(booking => 
                new Date(booking.time).toDateString() === today
            );
            
            document.getElementById('todayTotal').textContent = todayBookings.length;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonState() {
            const btn = document.getElementById('bookBtn');
            const now = new Date();
            const currentHour = now.getHours();
            
            // æ£€æŸ¥æ˜¯å¦åœ¨è¥ä¸šæ—¶é—´å†…
            const startHour = BUSINESS_HOURS.start_hour;
            const endHour = BUSINESS_HOURS.end_hour;
            
            if (currentHour < startHour || currentHour >= endHour) {
                btn.disabled = true;
                btn.textContent = 'éè¥ä¸šæ—¶é—´';
                return;
            }
            
            // æ£€æŸ¥å–è´§æ—¶æ®µæ˜¯å¦åœ¨è¥ä¸šæ—¶é—´å†…
            if (!pickupSlot) {
                btn.disabled = true;
                btn.textContent = 'æ— æ³•é¢„çº¦';
                return;
            }
            
            const pickupSlotHour = pickupSlot.getHours();
            if (pickupSlotHour >= endHour) {
                btn.disabled = true;
                btn.textContent = 'ä»Šæ—¥å·²ç»“æŸ';
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä»Šå¤©å·²é¢„çº¦
            const today = new Date().toDateString();
            const bookings = JSON.parse(localStorage.getItem('cake_bookings') || '[]');
            const deviceId = localStorage.getItem('device_id');
            
            const userBookedToday = bookings.some(booking => {
                const bookingDate = new Date(booking.time).toDateString();
                return bookingDate === today && booking.deviceId === deviceId;
            });
            
            if (userBookedToday) {
                btn.disabled = true;
                btn.textContent = 'ä»Šæ—¥å·²é¢„çº¦';
            } else {
                btn.disabled = false;
                btn.textContent = 'âœ… è·å–ä½ç½®å¹¶é¢„çº¦';
            }
        }

        // è·å–åœ°ç†ä½ç½®
        function getLocation() {
            const btn = document.getElementById('bookBtn');
            const statusEl = document.getElementById('status');
            btn.disabled = true;
            btn.textContent = 'ğŸ“ è·å–ä½ç½®ä¸­...';
            statusEl.textContent = '';

            if (!navigator.geolocation) {
                statusEl.innerHTML = '<span style="color:red">âŒ æµè§ˆå™¨ä¸æ”¯æŒå®šä½</span>';
                resetButton();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    const dist = calculateDistance(
                        pos.coords.latitude, 
                        pos.coords.longitude, 
                        CONFIG.lat, 
                        CONFIG.lng
                    );
                    
                    if (dist <= CONFIG.radius) {
                        statusEl.innerHTML = 'âœ… éªŒè¯é€šè¿‡ (è·ç¦» ' + dist.toFixed(0) + 'ç±³)ï¼Œæ­£åœ¨é¢„çº¦...';
                        setTimeout(() => {
                            createBooking();
                        }, 1000);
                    } else {
                        statusEl.innerHTML = 'âŒ è¯·é è¿‘é—¨åº—åå†è¯• (å½“å‰è·ç¦» ' + dist.toFixed(0) + 'ç±³)';
                        resetButton();
                    }
                },
                function(err) {
                    let msg = 'å®šä½å¤±è´¥';
                    if (err.code === 1) msg = 'è¯·å¼€å¯ä½ç½®æƒé™';
                    statusEl.innerHTML = '<span style="color:red">' + msg + '</span>';
                    resetButton();
                },
                { timeout: 10000, enableHighAccuracy: true }
            );
        }

        // åˆ›å»ºé¢„çº¦
        function createBooking() {
            const deviceId = localStorage.getItem('device_id') || generateDeviceId();
            localStorage.setItem('device_id', deviceId);
            
            // ç”Ÿæˆå–è´§ç 
            const code = 'CAKE' + Math.floor(1000 + Math.random() * 9000);
            
            // è·å–å–è´§æ—¶æ®µä¿¡æ¯ï¼ˆä¸‹ä¸€æ—¶æ®µï¼‰
            const pickupEnd = new Date(pickupSlot.getTime());
            pickupEnd.setMinutes(pickupEnd.getMinutes() + SLOT_DURATION);
            const pickupSlotStr = formatTime(pickupSlot) + ' - ' + formatTime(pickupEnd);
            
            // è·å–å½“å‰é¢„çº¦æ—¶æ®µä½œä¸ºè®°å½•
            const currentSlotKey = formatTime(currentSlot.start);
            
            // åˆ›å»ºé¢„çº¦è®°å½•
            const booking = {
                code: code,
                deviceId: deviceId,
                slotKey: currentSlotKey,  // è®°å½•é¢„çº¦æ—¶æ®µ
                pickupSlot: pickupSlotStr,  // å–è´§æ—¶æ®µæ˜¯ä¸‹ä¸€æ—¶æ®µ
                time: new Date().toISOString(),
                distance: 'å·²éªŒè¯'
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            let bookings = JSON.parse(localStorage.getItem('cake_bookings') || '[]');
            bookings.push(booking);
            localStorage.setItem('cake_bookings', JSON.stringify(bookings));
            
            // æ˜¾ç¤ºæˆåŠŸç»“æœ
            document.getElementById('pickupSlot').textContent = pickupSlotStr;
            document.getElementById('codeDisplay').textContent = code;
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('status').innerHTML = '';
            
            // ç¦ç”¨æŒ‰é’®
            const btn = document.getElementById('bookBtn');
            btn.disabled = true;
            btn.textContent = 'ä»Šæ—¥å·²é¢„çº¦';
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateDailyStats();
            updateTotalBookings();
        }

        // é‡ç½®æŒ‰é’®çŠ¶æ€
        function resetButton() {
            const btn = document.getElementById('bookBtn');
            updateButtonState();
        }

        // è®¡ç®—è·ç¦»å‡½æ•°
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // å‘˜å·¥åŠŸèƒ½
        function showStaffLogin() {
            document.getElementById('staff-login').style.display = 'block';
        }

        function hideStaffLogin() {
            document.getElementById('staff-login').style.display = 'none';
        }

        function doStaffLogin() {
            const pin = document.getElementById('staffPinInput').value.trim();
            if (!pin) return;
            let validPins = JSON.parse(localStorage.getItem('staff_pins') || '["J0S1TA7"]');
            if (validPins.includes(pin)) {
                hideStaffLogin();
                document.getElementById('member-section').style.display = 'none';
                document.getElementById('staff-panel').style.display = 'block';
                updateDailyStats();
                updateTotalBookings();
                updateTimeDisplay();
            } else {
                alert('å·¥å·é”™è¯¯');
            }
        }

        function addNewStaff() {
            document.getElementById('add-staff-modal').style.display = 'block';
            document.getElementById('newStaffPin').value = '';
        }

        function saveNewStaff() {
            const newPin = document.getElementById('newStaffPin').value.trim();
            if (!newPin) {
                alert('è¯·è¾“å…¥å·¥å·');
                return;
            }
            let pins = JSON.parse(localStorage.getItem('staff_pins') || '["J0S1TA7"]');
            if (pins.includes(newPin)) {
                alert('è¯¥å·¥å·å·²å­˜åœ¨');
                return;
            }
            pins.push(newPin);
            localStorage.setItem('staff_pins', JSON.stringify(pins));
            document.getElementById('add-staff-modal').style.display = 'none';
            alert('æ–°å·¥å·æ·»åŠ æˆåŠŸï¼');
        }

        function editLocation() {
            document.getElementById('edit-location-modal').style.display = 'block';
            document.getElementById('newLat').value = CONFIG.lat;
            document.getElementById('newLng').value = CONFIG.lng;
        }

        function saveNewLocation() {
            const latStr = document.getElementById('newLat').value.trim();
            const lngStr = document.getElementById('newLng').value.trim();

            const lat = parseFloat(latStr);
            const lng = parseFloat(lngStr);

            if (isNaN(lat) || isNaN(lng)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—');
                return;
            }

            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('ç»çº¬åº¦èŒƒå›´ä¸åˆæ³•');
                return;
            }

            CONFIG.lat = lat;
            CONFIG.lng = lng;
            localStorage.setItem('store_config', JSON.stringify(CONFIG));
            document.getElementById('edit-location-modal').style.display = 'none';
            alert('é—¨åº—å®šä½å·²æ›´æ–°ï¼');
        }

        // ä¿®æ”¹è¥ä¸šæ—¶é—´
        function editBusinessHours() {
            const modal = document.getElementById('edit-hours-modal');
            document.getElementById('startHour').value = BUSINESS_HOURS.start_hour;
            document.getElementById('endHour').value = BUSINESS_HOURS.end_hour;
            modal.style.display = 'block';
        }

        function saveBusinessHours() {
            const startHour = parseInt(document.getElementById('startHour').value);
            const endHour = parseInt(document.getElementById('endHour').value);

            if (isNaN(startHour) || isNaN(endHour)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´');
                return;
            }

            if (startHour >= endHour) {
                alert('å¼€å§‹æ—¶é—´å¿…é¡»å°äºç»“æŸæ—¶é—´');
                return;
            }

            if (startHour < 0 || startHour > 23 || endHour < 0 || endHour > 23) {
                alert('æ—¶é—´å¿…é¡»åœ¨0-23ä¹‹é—´');
                return;
            }

            BUSINESS_HOURS.start_hour = startHour;
            BUSINESS_HOURS.end_hour = endHour;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('business_hours', JSON.stringify(BUSINESS_HOURS));
            
            // æ›´æ–°æ˜¾ç¤º
            updateHoursDisplay();
            
            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('edit-hours-modal').style.display = 'none';
            
            alert('è¥ä¸šæ—¶é—´å·²æ›´æ–°ä¸º ' + 
                  startHour.toString().padStart(2, '0') + ':00 - ' + 
                  endHour.toString().padStart(2, '0') + ':00');
            
            // é‡æ–°æ£€æŸ¥å½“å‰æ—¶é—´çŠ¶æ€
            updateTimeDisplay();
        }

        function clearTodayData() {
            if (confirm('ç¡®å®šæ¸…é™¤ä»Šæ—¥æ‰€æœ‰é¢„çº¦è®°å½•ï¼Ÿè¿™å°†æ— æ³•æ¢å¤ï¼')) {
                const today = new Date().toDateString();
                let allBookings = JSON.parse(localStorage.getItem('cake_bookings') || '[]');
                
                const filteredBookings = allBookings.filter(booking => 
                    new Date(booking.time).toDateString() !== today
                );
                
                localStorage.setItem('cake_bookings', JSON.stringify(filteredBookings));
                updateDailyStats();
                updateTotalBookings();
                alert('ä»Šæ—¥æ•°æ®å·²æ¸…ç©ºï¼');
                
                location.reload();
            }
        }

        function logoutStaff() {
            goBackToMember();
        }

        function goBackToMember() {
            document.getElementById('staff-panel').style.display = 'none';
            document.getElementById('member-section').style.display = 'block';
            initPage();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
        });
    </script>
</body>
</html>